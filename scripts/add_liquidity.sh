#!/bin/bash

# Uniswap V3 on Polygon addresses
FACTORY=0x1F98431c8aD98523631AE4a59f267346ea31F984
POSITION_MANAGER=0xC36442b4a4522E871399CD717aBDD847Ab11FE88
WMATIC=0x0d500B1d8E8eF31E21C99d1Db9A6444d3ADf1270

# Config
PORK=0x3acc6396458daAf9F0b0545a4752591880eF6e28
FEE=3000
AMOUNT_PORK_DESIRED=40000000000000000000000000000
AMOUNT_WMATIC_DESIRED=10000000000000000000
AMOUNT_PORK_MIN=0
AMOUNT_WMATIC_MIN=0.00001
DEADLINE=$(($(date +%s) + 3600))
RECIPIENT=0x23cE6D1E06D8509A5668e9E1602de1c2b19ba3a2
SQRT_PRICE=7922816251426433759354395033600  # Adjust for initial price
TICK_LOWER=-887220
TICK_UPPER=887220

# Determine token order
if [ $(cast to-uint256 $WMATIC) -lt $(cast to-uint256 $PORK) ]; then
  TOKEN0=$WMATIC; TOKEN1=$PORK
  AMOUNT0_DESIRED=$AMOUNT_WMATIC_DESIRED; AMOUNT1_DESIRED=$AMOUNT_PORK_DESIRED
  AMOUNT0_MIN=$AMOUNT_WMATIC_MIN; AMOUNT1_MIN=$AMOUNT_PORK_MIN
else
  TOKEN0=$PORK; TOKEN1=$WMATIC
  AMOUNT0_DESIRED=$AMOUNT_PORK_DESIRED; AMOUNT1_DESIRED=$AMOUNT_WMATIC_DESIRED
  AMOUNT0_MIN=$AMOUNT_PORK_MIN; AMOUNT1_MIN=$AMOUNT_WMATIC_MIN
  SQRT_PRICE=792281625142643392428113920
fi

# Approve tokens
cast send $PORK "approve(address,uint256)" $POSITION_MANAGER $AMOUNT_PORK_DESIRED --private-key $PRIVATE_KEY --rpc-url $POLYGON_RPC
cast send $WMATIC "approve(address,uint256)" $POSITION_MANAGER $AMOUNT_WMATIC_DESIRED --private-key $PRIVATE_KEY --rpc-url $POLYGON_RPC

# Get/create pool
POOL=$(cast call $FACTORY "getPool(address,address,uint24)" $TOKEN0 $TOKEN1 $FEE --rpc-url $POLYGON_RPC)
if [ "$POOL" = "0x0000000000000000000000000000000000000000" ]; then
  cast send $FACTORY "createPool(address,address,uint24)" $TOKEN0 $TOKEN1 $FEE --private-key $PRIVATE_KEY --rpc-url $POLYGON_RPC
  POOL=$(cast call $FACTORY "getPool(address,address,uint24)" $TOKEN0 $TOKEN1 $FEE --rpc-url $POLYGON_RPC)
  cast send $POOL "initialize(uint160)" $SQRT_PRICE --private-key $PRIVATE_KEY --rpc-url $POLYGON_RPC
fi

# Mint position
cast send $POSITION_MANAGER "mint((address,address,uint24,int24,int24,uint256,uint256,uint256,uint256,address,uint256))" \
  "($TOKEN0,$TOKEN1,$FEE,$TICK_LOWER,$TICK_UPPER,$AMOUNT0_DESIRED,$AMOUNT1_DESIRED,$AMOUNT0_MIN,$AMOUNT1_MIN,$RECIPIENT,$DEADLINE)" \
  --private-key $PRIVATE_KEY --rpc-url $POLYGON_RPC

echo "Liquidity added! Check wallet for NFT."
